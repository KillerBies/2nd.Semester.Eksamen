@page "/InvoiceOverview"
@namespace _2nd.Semester.Eksamen.WebUi.Components.Pages.InvoicePages
@using System.IO;
@inject IJSRuntime JS
@using _2nd.Semester.Eksamen.Application.DTO;
@using _2nd.Semester.Eksamen.Application
@using _2nd.Semester.Eksamen.Application.ApplicationInterfaces;
@using _2nd.Semester.Eksamen.WebUi.Components.Pages.ProductPages.BookingPages
@rendermode InteractiveServer
@inject IInvoiceService invoiceService

<div style="background-color:#F3F2F2; height:100vh">
    <div class="overview-page">
        <div class="shadow-sm" style="background-color:#F3F2F2;">
            <div class="page-header">
                <div>
                    <h1>Faktura</h1>
                    <p class="subtitle">Oversigt over alle Faktura</p>
                </div>
                <div class="input-group">
                <div class="equal-row ms-auto">
                        <input type="text"
                               placeholder="Søg Navn..."
                               @bind="SearchTermName"
                               @bind:event="oninput" />
                        <input type="date" title="Fra..." placeholder="Dato..." @bind="SearchTermDateStart" />
                        <input type="date" title="Til..." placeholder="Dato..." @bind="SearchTermDateEnd" />
                    </div>
                </div>
            </div>
            <div class="overview-page-content">
                @if (orderSnapshotDTOs == null || !orderSnapshotDTOs.Any())
                {
                    <p>Ingen ordrer fundet.</p>
                }
                else
                {
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Ordre Id</th>
                                <th>Kundenavn</th>
                                <th>Total</th>
                                <th>Betalingsdato</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var orderSnapshotDTO in FilterdOrders)
                            {
                                <tr @onclick="() => OpenDetails(orderSnapshotDTO)" style="cursor:pointer;">
                                    <td>@orderSnapshotDTO.Id</td>
                                    <td>@orderSnapshotDTO.Name</td>
                                    <td>@orderSnapshotDTO.TotalPaid</td>
                                    <td>@orderSnapshotDTO.PaymentDate</td>
                                    <td>  <button @onclick="() => DownloadInvoiceAsync(orderSnapshotDTO.PdfFile)"> download faktura </button> </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>
<CreateWindow IsVisible=isVisible IsVisibleChanged="v => isVisible = v" StyleParameters="background-color: #F3F2F2; padding:0;width: 33%; min-width: max-content; scrollbar-width:none;flex-shrink: 0;">
    @if (CurrentContext != null)
    {
        <OrderDetails OrderContext="(OrderSnapShotContext)CurrentContext"/>
    }
</CreateWindow>


@code {
    public string SearchTermName { get; set; } = "";
    private DateTime? SearchTermDateStart;
    private DateTime? SearchTermDateEnd;
    public Stack<DetailsContext> DetailsStack { get; set; } = new Stack<DetailsContext>();
    public DetailsContext CurrentContext => DetailsStack.Any() ? DetailsStack.Peek() : null;
    private List<OrderSnapshotDTO> FilterdOrders => orderSnapshotDTOs.Where(o => (string.IsNullOrWhiteSpace(SearchTermName) || o.Name.Contains(SearchTermName, StringComparison.OrdinalIgnoreCase)) && (!SearchTermDateStart.HasValue || o.PaymentDate >= DateOnly.FromDateTime(SearchTermDateStart.Value)) && (!SearchTermDateEnd.HasValue || o.PaymentDate <= DateOnly.FromDateTime(SearchTermDateEnd.Value))).ToList();
    private bool isVisible = false;
    [Inject] public IHistoryService historyService { get; set; }
    private List<OrderSnapshotDTO> orderSnapshotDTOs;

    protected override async Task OnInitializedAsync()
    {
        orderSnapshotDTOs = await invoiceService.GetAllSnapshotsAsync();
    }
    private async Task OpenDetails(OrderSnapshotDTO snap)
    {
        isVisible = true;
        var detail = await historyService.GetOrderSnapshotByGuid(snap.OrderGuid);
        DetailsStack.Push(detail);
    }
    private async Task DownloadInvoiceAsync(Byte[] Pdfbytes)
    {
        var fileStream = new MemoryStream(Pdfbytes);
        var fileName = "Faktura.pdf";

        using var streamRef = new DotNetStreamReference(stream: fileStream);

        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}
