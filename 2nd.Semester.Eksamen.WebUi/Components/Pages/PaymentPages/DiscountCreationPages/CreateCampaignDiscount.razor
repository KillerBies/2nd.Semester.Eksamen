@namespace _2nd.Semester.Eksamen.WebUi.Components.Pages.PaymentPages.DiscountCreationPages
@using _2nd.Semester.Eksamen.Domain.Entities.Discounts
@using _2nd.Semester.Eksamen.Application.ApplicationInterfaces
@using _2nd.Semester.Eksamen.Application.DTO.ProductDTO
@rendermode InteractiveServer

@if (campaignDTO!=null)
{
    <div class="card m-0 border-0 shadow-none" style="background-color:#F3F2F2;">
        <EditForm Model="@campaignDTO" class="row p-3">
            <div class="w-100">
                <h2>@(IsEdit ? "Rediger Kampagne" : "Opret Kampagne")</h2>
                <div class="d-flex flex-column p-3">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="Name" class="form-labels">Navn:</label>
                            <InputText id="Name" @bind-Value="campaignDTO.Name" class="form-control" placeholder="Kampagnenavn..." />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="TreatmentDiscount" class="form-labels">Rabat på behandling (%):</label>
                            <InputNumber id="TreatmentDiscount" @bind-Value="campaignDTO.TreatmentDiscount" class="form-control" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="ProductDiscount" class="form-labels">Rabat på produkter (%):</label>
                            <InputNumber id="ProductDiscount" @bind-Value="campaignDTO.ProductDiscount" class="form-control" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="Start" class="form-labels">Startdato:</label>
                            <InputDate id="Start" @bind-Value="campaignDTO.Start" class="form-control" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="End" class="form-labels">Slutdato:</label>
                            <InputDate id="End" @bind-Value="campaignDTO.End" class="form-control" />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label class="form-labels">Vælg gældene produkter:</label>
                        @if(ProductItems == null || !ProductItems.Any())
                        {
                            <p class="text-muted mb-0 text-center">
                                Ingen produkter registreret.
                            </p>
                        }
                        else
                        {
                            <div class="border rounded p-2" style="overflow-y:scroll; max-height:7.7rem">
                                @foreach (var product in ProductItems.Where(s => !string.IsNullOrWhiteSpace(s.ProductName)))
                                {
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input"
                                                       @bind-Value="product.Status" />
                                        <label class="form-check-label ms-2">
                                            @product.ProductName
                                        </label>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <label for="Description" class="form-labels">Beskrivelse:</label>
                            <InputTextArea id="Description" @bind-Value="campaignDTO.Description" class="form-control" placeholder="Beskrivelse..." maxlength="500" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div>
                                <label class="form-labels">Gælder for behandlinger:</label>
                                <InputCheckbox @bind-Value="campaignDTO.AppliesToTreatment" />
                            </div>
                            <div>
                                <label class="form-labels">Gælder for produkter:</label>
                                <InputCheckbox @bind-Value="campaignDTO.AppliesToProduct" />
                            </div>
                        </div>
                    </div>
                </div>
                @if (IsEdit)
                {
                    <button class="btn card-btn w-100" @onclick="UpdateDiscount">Gem Ændringer</button>
                }
            </div>
        </EditForm>
    </div>
}

@code {
    [Parameter] public CampaignDiscountDTO campaignDTO { get; set; }
    [Inject] IDiscountApplicationService _discountService { get; set; }
    [Inject] IProductService _productService { get; set; }
    [Parameter] public EventCallback<CampaignDiscountDTO> campaignDTOChanged { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public bool IsEdit { get; set; } = false;
    [Parameter] public DiscountOverviewDTO discountEdit { get; set; }
    public List<ChooseProductItemDTO> ProductItems { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            campaignDTO = new CampaignDiscountDTO(discountEdit);
        }
        ProductItems = await _productService.GetAllProductItemsAsync();
        foreach(var item in ProductItems.Where(p => campaignDTO.ProductIds.Contains(p.ProductId)))
        {
            item.Status = true;
        }
    }
    public async Task OnChange()
    {
        await campaignDTOChanged.InvokeAsync(campaignDTO);
    }
    public async Task UpdateDiscount()
    {
        try
        {
            campaignDTO.ProductIds = ProductItems.Where(p => p.Status == true).Select(p => p.ProductId).ToList();
            await _discountService.UpdateCampaignDiscountAsync(campaignDTO);
            await OnClose.InvokeAsync();
        }
        catch
        {

        }
    }
}