@rendermode InteractiveServer
@using _2nd.Semester.Eksamen.Application.ApplicationInterfaces;
@using _2nd.Semester.Eksamen.Domain
@using _2nd.Semester.Eksamen.Domain.Entities.Products
@using _2nd.Semester.Eksamen.Domain.Entities.History
@using _2nd.Semester.Eksamen.Domain.Entities.Products.BookingProducts
@using _2nd.Semester.Eksamen.Domain.Entities.Persons.Customer
@using _2nd.Semester.Eksamen.Domain.Entities.Products.BookingProducts.TreatmentProducts
@using _2nd.Semester.Eksamen.WebUi.Components.Shared
@using _2nd.Semester.Eksamen.WebUi.Components.Pages.PaymentPages
@using _2nd.Semester.Eksamen.Application.DTO.ProductDTO.BookingDTO
@using _2nd.Semester.Eksamen.Application.DTO.PersonDTO.CustomersDTO
@using _2nd.Semester.Eksamen.Application
@using Components.Pages.ProductPages.BookingPages
@inject IBookingService bookingService

@if (!IsSnapshot)
{
    <div class="d-flex flex-column h-100">


        <div class="card-header text-white rounded-top gap-5 px-3 py-2" style="background-color:#034265; display:flex; flex-direction:row; width:60vw;">
            <h2 class="mb-0 text-white clickable" @onclick="()=>OnClickCustomer.InvokeAsync(SelectedBooking.CustomerGuid)"> @(SelectedBooking.Customer is PrivateCustomerDTO pc ? $"{SelectedBooking.Customer.Name} {pc.LastName}" : SelectedBooking.Customer.Name)</h2>
            <button class="btn btn-primary ms-auto" style="width: 15%;" @onclick="() => OnPay.InvokeAsync(SelectedBooking)"><b>Betal</b></button>
        </div>


        <div class="p-4 flex-grow-1 overflow-auto">

            <div class="text-center mb-4 border-bottom border-dashed pb-3">
                <h3 class="mb-1">@SelectedBooking.Start.ToString("dd/MM/yyyy")</h3>
                <h5 class="mb-0">@SelectedBooking.Start.ToString("HH:mm") - @SelectedBooking.End.ToString("HH:mm")</h5>
                <h7><span class="badge bg-dark ms-auto bg-opacity-75"> @(CurrentTime<SelectedBooking.Start? TimeUntil : TimeSinceThen)</span></h7>
            </div>


            @if (SelectedBooking.TreatmentBookingDTOs.Any())
            {
                <div class="mb-4">
                    @foreach (var treatment in SelectedBooking.TreatmentBookingDTOs)
                    {
                        <div class="mb-3 p-3 border rounded shadow-sm">
                            <h5 class="fw-bold mb-1 clickable" @onclick="()=>OnClickTreatment.InvokeAsync(treatment.Treatment.TreatmentGuid)">@treatment.Treatment.Name</h5>
                            <div class="info-row">
                                <span class="info-label">Tid</span>
                                <span class="info-value">@treatment.Start.ToString("HH:mm") - @treatment.End.ToString("HH:mm")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Pris</span>
                                <span class="info-value">@treatment.Price.ToString("C")</span>
                            </div>
                            <div class="info-row clickable" @onclick="() => OnClickEmployee.InvokeAsync(treatment.Employee.EmployeeGuid)">
                                <span class="info-label">Ansat</span>
                                <span class="info-value">@treatment.Employee.Name</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Erfaring</span>
                                <span class="info-value"> @treatment.Employee.ExperienceLevel</span>
                            </div>
                        </div>
                    }
                </div>
            }


            <div class="d-flex flex-column gap-2">
                <div class="btn-group">
                    <button class="btn card-btn w-50 " @onclick="() => OnDelete.InvokeAsync(Context)" style="background-color:crimson">Slet</button>
                    <button class="btn card-btn w-50" @onclick="() => OnEdit.InvokeAsync(Context)">Rediger</button>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="d-flex flex-column h-100">


        <div class="card-header text-white rounded-top gap-5 px-3 py-2" style="background-color:#034265; display:flex; flex-direction:row; width:60vw;">
            <h2 class="mb-0 text-white clickable" @onclick="() => OnClickCustomer.InvokeAsync(SelectedCompletedBooking.CustomerGuid)">@SelectedCompletedBooking.Customer.Name</h2>
        </div>
        <div class="info-row">
            <span class="info-label">OrderId</span>
            <span class="info-value clickable" @onclick="() => OnOrderClick.InvokeAsync(SelectedCompletedBooking.OrderGuid)">@SelectedCompletedBooking.OrderGuid</span>
        </div>
        <div class="p-4 flex-grow-1 overflow-auto">

            <div class="text-center mb-4 border-bottom border-dashed pb-3">
                <h3 class="mb-1">@SelectedCompletedBooking.Start.ToString("dd/MM/yyyy")</h3>
                <h5 class="mb-0">@SelectedCompletedBooking.Start.ToString("HH:mm") - @SelectedBooking.End.ToString("HH:mm")</h5>
                <h7><span class="badge bg-dark ms-auto bg-opacity-75">@CompletedTimeSince</span></h7>
            </div>


            @if (SelectedCompletedBooking.TreatmentBookingDTOs.Any())
            {
                <div class="mb-4">
                    @foreach (var treatment in SelectedCompletedBooking.TreatmentBookingDTOs)
                    {
                        <div class="mb-3 p-3 border rounded shadow-sm">
                            <h5 class="fw-bold mb-1 clickable" @onclick="() => OnClickTreatment.InvokeAsync(treatment.Treatment.TreatmentGuid)">@treatment.Treatment.Name</h5>
                            <div class="info-row">
                                <span class="info-label">Tid</span>
                                <span class="info-value">@treatment.Start.ToString("HH:mm") - @treatment.End.ToString("HH:mm")</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Pris</span>
                                <span class="info-value">@treatment.Price.ToString("C")</span>
                            </div>
                            <div class="info-row clickable" @onclick="() => OnClickEmployee.InvokeAsync(treatment.Employee.EmployeeGuid)">
                                <span class="info-label">Ansat</span>
                                <span class="info-value">@treatment.Employee.Name</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Kategori</span>
                                <span class="info-value">@treatment.Treatment.Category</span>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}


@code {

    [Inject] IBookingOverviewService _bookingOverviewService { get; set; }
    private DateTime CurrentTime => DateTime.Now;

    private TimeSpan TimeTill => SelectedBooking.Start - CurrentTime;
    private string TimeUntil => $"Om {DaysUntil} {HoursUntil} {MinutesUntil}";
    private string DaysUntil => TimeTill.Days > 0 ? $"{TimeTill.Days} Dage" : "";
    private string HoursUntil => TimeTill.Hours > 0 ? $"{TimeTill.Hours} Timer" : "";
    private string MinutesUntil => TimeTill.Minutes > 0 ? $"{TimeTill.Minutes} Minutter" : "";

    private TimeSpan TimeSince => CurrentTime - SelectedBooking.Start;
    private string TimeSinceThen => $"For {DaysSinceThen} {HoursSinceThen} {MinutesSinceThen} Siden";
    private string DaysSinceThen => $"{TimeSince.Days} Dage";
    private string HoursSinceThen => $"{TimeSince.Hours} Timer";
    private string MinutesSinceThen => $"{TimeSince.Minutes} Minutter";

    private TimeSpan TimeSinceCompleted => CurrentTime - SelectedCompletedBooking.Start;

    private string CompletedTimeSince =>
        $"For {TimeSinceCompleted.Days} Dage, {TimeSinceCompleted.Hours} Timer, og {TimeSinceCompleted.Minutes} Minutter Siden";

    public BookingDTO SelectedBooking { get; set; }
    public BookingDTO SelectedCompletedBooking { get; set; }

    [Parameter] public EventCallback<BookingDTO> OnPay { get; set; }
    [Parameter] public BookingDetailsContext Context { get; set; }
    [Parameter] public BookingSnapShotContext SnapshotContext { get; set; }
    [Parameter] public EventCallback<Guid> OnClickCustomer { get; set; }
    [Parameter] public EventCallback<Guid> OnClickEmployee { get; set; }
    [Parameter] public EventCallback<Guid> OnClickTreatment { get; set; }
    [Parameter] public EventCallback<Guid> OnOrderClick { get; set; }
    [Parameter] public EventCallback<DetailsContext> OnEdit { get; set; }
    [Parameter] public EventCallback<DetailsContext> OnDelete { get; set; }
    [Parameter] public bool IsSnapshot { get; set; } = false;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (IsSnapshot)
            {
                SelectedCompletedBooking = SnapshotContext.OrderInfo;
            }
            else
            {
                SelectedBooking = Context.Booking;
            }
        }
        catch
        {
        }
    }
}
