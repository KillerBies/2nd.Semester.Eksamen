@page "/BookingForm/{CustomerId:int}"
@page "/BookingForm/{CustomerId:int}/{BookingId:int}"
@namespace _2nd.Semester.Eksamen.WebUi.Components.Pages.ProductPages.BookingPages
@rendermode InteractiveServer
@using _2nd.Semester.Eksamen.Application.DTO.PersonDTO.EmployeeDTO;
@using _2nd.Semester.Eksamen.Application.DTO.ProductDTO.BookingDTO;
@using _2nd.Semester.Eksamen.Application.DTO.PersonDTO;
@using _2nd.Semester.Eksamen.Application.DTO;
@using System.ComponentModel.DataAnnotations
@using _2nd.Semester.Eksamen.WebUi.Components.Pages
@using _2nd.Semester.Eksamen.WebUi.Components.Shared
@using _2nd.Semester.Eksamen.Domain.RepositoryInterfaces.PersonInterfaces.CustomerInterfaces;
@using Microsoft.AspNetCore.Components.Web.Extensions;
@using _2nd.Semester.Eksamen.WebUi.Components.Pages.ProductPages.BookingPages;
@inject NavigationManager Navi
@inject ICustomerRepository customerRepository

@if (EditContext != null)
{

<div style="background-color:#F3F2F2; min-height:100vh;">
    <div style="background-color:#F3F2F2; height:100%;">
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger">
                @_errorMessage
            </div>
        }
        <div class="shadow-sm" style="max-height:none;">
            <div class="page-header">
                <span class="title">Kunde: @CustomerName</span>
            </div>
            <EditForm EditContext="@EditContext" class="row p-5" style="margin-left: 20%; margin-right: 20%;"
                      OnValidSubmit="@HandleValidSubmit"
                      OnInvalidSubmit="@HandleInvalidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div class="Treatments">
                    @for (int i = 0; i < Booking.TreatmentBookingDTOs.Count(); i++)
                    {
                        <TreatmentEditor TreatmentBooking="Booking.TreatmentBookingDTOs[i]"
                                         IsEdit="IsEdit"
                                         OnRemove="RemoveTreatment"
                                         PossibleEmployees="AllEmployees"
                                         PossibleTreatments="AllTreatments"
                                         Onchange="UpdateTreatment"
                                         Index="i"
                                         OnDown="MoveDown"
                                         OnUp="MoveUp">
                        </TreatmentEditor>
                    }
                </div>
                <button class="add-treatment" type="button" title="Tilføj Behandling" @onclick="AddTreatment">+</button>
                <div class="possible-times-container">
                    <div class="possible-times-header" style="border-radius:@(IsDropdownOpen ? "12px 12px 0 0" : "12px 12px 12px 12px");">
                        <div>
                            <span>Start Dato</span>
                            <input type="date" @bind="@startDate" disabled="@(checkfields())" title="Sæt start dato på genereret tider" min="@DateTime.Now" />
                        </div>
                        <div class="btn-group">
                            <div>
                                <label>Tidsrum:</label>
                                <input type="time" @bind="StartTime" class="input-time" title="Sæt start tid for genereret tiders tidsrum" />
                                <b>-</b>
                                <input type="time" @bind="EndTime" class="input-time" title="Sæt slut tid for genereret tiders tidsrum" />
                            </div>
                        </div>
                        <div class="btn-group gap-3" style="margin-right:1rem;">
                            <button type="button" class="time-button" @onclick="PageBackwards" disabled="@(CurrentIndex == 0)" title="Gå Tilbage I Tid">&#9664;</button>
                            <button type="button" class="time-button" @onclick="FowardPage" disabled="@(checkfields())" title="Gå Frem I Tid">&#9654;</button>
                                <button type="button" class="time-button" @onclick="refreshAvailableSlots" disabled="@(checkfields())" title="Generer Mulige Tider"><i class="bi bi-arrow-clockwise"></i></button>
                        </div>
                    </div>
                    @if (IsDropdownOpen)
                    {
                        <div class="pt-1" style="width:100%; text-align:center; justify-content:center;">
                            <span style="font-weight:600;">@(IsEdit ? $"Gamle Tid {EditBooking.Start.ToString("M")}: {EditBooking.Start.ToString("t")} - {EditBooking.End.ToString("t")}" : "")</span>
                        </div>
                        <div class="time-grid">
                            @foreach (var spot in Pages[CurrentIndex].Where(t => TimeOnly.FromDateTime(t.End) <= EndTime))
                            {
                                <TimeCard OnSelect="SelectTimeSlot" availableTime="spot" IsSelected="@(timeSelected.Start == spot.Start && timeSelected.End == spot.End)"></TimeCard>
                            }
                        </div>
                    }
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-primary mt-3" title="Anuller Booking" @onclick="OnCancel">Anuller</button>
                    @if (!IsEdit)
                    {
                            <button type="submit" class="btn btn-primary mt-3" title="Lav Booking" @onclick="ConfirmBooking" disabled="@(checkfieldsAndTime())">Lav Booking</button>
                    }
                    else
                    {
                        <button type="submit" class="btn btn-primary mt-3" title="Lav Booking" @onclick="CreateBooking" disabled="@(checkfieldsAndTime())">Gem Ændringer</button>
                    }
                </div>
            </EditForm>
        </div>
    </div>
</div>


<CreateWindow @bind-IsVisible="showPopup" StyleParameters="background-color: transparent; padding:0;width:33vw; height:fit-content;scrollbar-width:none;z-index:1000;">
        <BookingDetails Context="confirmContext" IsCreate=true OnClose="CreateBooking"></BookingDetails>
</CreateWindow>
}
else
{
    <p>Loading booking...</p>
}